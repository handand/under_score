<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manual WebRTC Demo (No Trickle ICE)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    textarea { width: 100%; height: 120px; margin-bottom: 0.5rem; }
    button { margin: 0.5rem 0; padding: 0.5rem 1rem; }
    #log { border: 1px solid #ccc; padding: 0.5rem; height: 150px; overflow-y: auto; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Manual WebRTC Demo</h1>
  <p><strong>Step 1:</strong> Host clicks "Create Offer", copies the blob and sends to Joiner.<br>
     <strong>Step 2:</strong> Joiner pastes Offer, clicks "Create Answer", copies blob and sends back.<br>
     <strong>Step 3:</strong> Host pastes Answer, clicks "Set Answer".<br>
     Once connected, use the chat below.</p>

  <h2>Host</h2>
  <button id="createOffer">Create Offer</button>
  <textarea id="offerOut" placeholder="Copy this and send to other peer"></textarea>
  <textarea id="localCandidatesOut" placeholder="Local ICE candidates (copy/send as they appear)"></textarea>
  <textarea id="answerIn" placeholder="Paste Answer here"></textarea>
  <textarea id="remoteCandidateIn" placeholder="Paste remote candidate here (one JSON candidate at a time)"></textarea>
  <button id="addRemoteCandidate">Add Remote Candidate</button>
  <button id="setAnswer">Set Answer</button>

  <h2>Joiner</h2>
  <textarea id="offerIn" placeholder="Paste Offer here"></textarea>
  <button id="createAnswer">Create Answer</button>
  <textarea id="answerOut" placeholder="Copy this and send to host"></textarea>
  <textarea id="localCandidatesOutJoiner" placeholder="Local ICE candidates (copy/send as they appear)"></textarea>
  <textarea id="remoteCandidateInJoiner" placeholder="Paste remote candidate here (one JSON candidate at a time)"></textarea>
  <button id="addRemoteCandidateJoiner">Add Remote Candidate</button>

  <h2>Chat</h2>
  <input id="msg" type="text" placeholder="Type a message" />
  <button id="sendMsg">Send</button>
  <div id="log"></div>

  <script>
    let pc;
    let channel;

    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    function log(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      document.getElementById("log").appendChild(div);
    }

    function appendLocalCandidate(textareaId, cand) {
      const ta = document.getElementById(textareaId);
      ta.value = ta.value + JSON.stringify(cand) + "\n";
    }

    function setupIceHandling(pcInstance, localCandidatesTextareaId) {
      pcInstance.onicecandidate = (event) => {
        // event.candidate === null means ICE gathering complete
        if (event.candidate) {
          appendLocalCandidate(localCandidatesTextareaId, event.candidate);
          log('Local ICE candidate gathered');
        } else {
          appendLocalCandidate(localCandidatesTextareaId, { candidate: null });
          log('ICE gathering complete');
        }
      };
    }

    // Host: create offer (trickle ICE)
    document.getElementById("createOffer").onclick = async () => {
      pc = new RTCPeerConnection(config);

      setupIceHandling(pc, 'localCandidatesOut');

      channel = pc.createDataChannel("chat");
      channel.onopen = () => log("✅ Data channel open!");
      channel.onmessage = (e) => log("Peer: " + e.data);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // With trickle ICE we immediately share the SDP; candidates will be sent separately
      document.getElementById("offerOut").value = JSON.stringify(pc.localDescription);
      log('Offer created (trickle ICE). Copy SDP and send to remote peer.');
    };

    // Host: set answer
    document.getElementById("setAnswer").onclick = async () => {
      if (!pc) return log('No PeerConnection exists. Create offer first.');
      let answerRaw = document.getElementById("answerIn").value.trim();
      if (!answerRaw) return log('No answer provided');
      try {
        const answer = JSON.parse(answerRaw);
        await pc.setRemoteDescription(answer);
        log("✅ Answer set!");
      } catch (err) {
        log('Error setting answer: ' + err);
      }
    };

    // Host: add remote candidate
    document.getElementById('addRemoteCandidate').onclick = async () => {
      if (!pc) return log('No PeerConnection exists.');
      const raw = document.getElementById('remoteCandidateIn').value.trim();
      if (!raw) return log('No candidate pasted');
      try {
        const obj = JSON.parse(raw);
        // ignore end-of-candidates marker
        if (obj && obj.candidate === null) {
          log('Received end-of-candidates marker (ignored)');
          return;
        }
        await pc.addIceCandidate(obj);
        log('✅ Remote candidate added');
      } catch (err) {
        log('addIceCandidate error: ' + err);
      }
    };

    // Joiner: create answer (trickle ICE)
    document.getElementById("createAnswer").onclick = async () => {
      pc = new RTCPeerConnection(config);

      setupIceHandling(pc, 'localCandidatesOutJoiner');

      pc.ondatachannel = (event) => {
        channel = event.channel;
        channel.onopen = () => log("✅ Data channel open!");
        channel.onmessage = (e) => log("Peer: " + e.data);
      };

      let offerRaw = document.getElementById('offerIn').value.trim();
      if (!offerRaw) return log('No offer provided');
      try {
        const offer = JSON.parse(offerRaw);
        await pc.setRemoteDescription(offer);

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Share the answer SDP; local candidates will appear separately
        document.getElementById("answerOut").value = JSON.stringify(pc.localDescription);
        log('Answer created (trickle ICE). Copy SDP and send to remote peer.');
      } catch (err) {
        log('Error creating/setting answer: ' + err);
      }
    };

    // Joiner: add remote candidate
    document.getElementById('addRemoteCandidateJoiner').onclick = async () => {
      if (!pc) return log('No PeerConnection exists.');
      const raw = document.getElementById('remoteCandidateInJoiner').value.trim();
      if (!raw) return log('No candidate pasted');
      try {
        const obj = JSON.parse(raw);
        if (obj && obj.candidate === null) {
          log('Received end-of-candidates marker (ignored)');
          return;
        }
        await pc.addIceCandidate(obj);
        log('✅ Remote candidate added');
      } catch (err) {
        log('addIceCandidate error: ' + err);
      }
    };

    // Send chat message
    document.getElementById("sendMsg").onclick = () => {
      const msg = document.getElementById("msg").value;
      if (channel && channel.readyState === "open") {
        channel.send(msg);
        log("Me: " + msg);
      }
    };
  </script>
</body>
</html>
